{"version":3,"file":"arch-edit-user-modal.js","sources":["../../../../../web-components/src/archUserTeamsSelector/src/styles.ts","../../../../../web-components/src/archUserTeamsSelector/src/arch-user-teams-selector.ts","../../../../../web-components/src/archEditUserModal/src/styles.ts","../../../../../web-components/src/archEditUserModal/src/arch-edit-user-modal.ts"],"sourcesContent":["import { css } from \"lit\";\n\nimport { global } from \"../../lib/styles\";\n\nexport default [\n  global,\n  css`\n    h3 {\n      margin-block-start: 0;\n      margin-block-end: 0.5rem;\n      font-size: 1rem;\n    }\n\n    ul {\n      line-height: 1.6rem;\n      font-style: italic;\n    }\n\n    button {\n      padding: 0;\n      background-color: transparent;\n      margin-left: 1rem;\n      text-decoration: underline;\n      color: red;\n      font-size: 0.8em;\n    }\n\n    label {\n      margin-left: 1.2rem;\n    }\n\n    select {\n      padding: 0.2rem;\n      border-radius: 8px;\n    }\n  `,\n];\n","import { PropertyValues, html } from \"lit\";\nimport { customElement, property } from \"lit/decorators.js\";\n\nimport { Paths } from \"../../lib/helpers\";\nimport { MinimalTeam } from \"../../lib/types\";\n\nimport { ArchSelectAdder } from \"../../archSelectAdder/index\";\n\nimport styles from \"./styles\";\n\n@customElement(\"arch-user-teams-selector\")\nexport class ArchUserTeamsSelector extends ArchSelectAdder<MinimalTeam> {\n  @property({ type: Array }) accountTeams!: Array<MinimalTeam>;\n  @property({ type: Array }) userTeams!: Array<MinimalTeam>;\n  @property({ type: Boolean }) readOnly!: boolean;\n\n  static styles = styles;\n\n  connectedCallback() {\n    const { readOnly } = this;\n    this.reset();\n    this.deselectButtonText = \"remove\";\n    this.emptyOptionsPlaceholder = html`\n      <em\n        >Your account doesnâ€™t have any teams yet.\n        <a href=\"${Paths.teams}\">Manage your teams here.</a></em\n      >\n    `;\n    this.headingLevel = 0;\n    this.readOnlyMessage = readOnly\n      ? html`<em>Contact an account admin to modify your teams.</em>`\n      : undefined;\n    this.selectCtaText = \"Add a team\";\n    this.valueGetter = (x) => String(x.id);\n    this.labelGetter = (x) => x.name;\n    super.connectedCallback();\n  }\n\n  willUpdate(changedProperties: PropertyValues) {\n    if (changedProperties.has(\"userTeams\")) {\n      this.reset();\n    }\n  }\n\n  reset() {\n    /* Reset selector options and selectedOptions */\n    const { accountTeams, userTeams } = this;\n    // Use Array.slice() to prevent mutation.\n    this.options = accountTeams.slice();\n    this.selectedOptions = userTeams.slice();\n  }\n}\n\n// Injects the tag into the global name space\ndeclare global {\n  interface HTMLElementTagNameMap {\n    \"arch-user-teams-selector\": ArchUserTeamsSelector;\n  }\n}\n","import { css } from \"lit\";\n\nimport { Bootstrap4Alerts } from \"../../lib/styles\";\nimport { ArchModal } from \"../../archModal/index\";\n\nexport default [\n  ...ArchModal.styles,\n  Bootstrap4Alerts,\n  css`\n    form > label {\n      font-weight: normal;\n      margin-top: 0.5rem;\n      font-size: 0.95rem;\n    }\n\n    form > label:first-child {\n      margin-top: 0;\n    }\n\n    form > label > em {\n      display: block;\n      font-size: 0.9em;\n    }\n\n    form > input,\n    form > select {\n      box-sizing: border-box;\n      width: 100%;\n    }\n\n    form > label[for=\"send-email\"],\n    form > input#send-email {\n      display: inline-block;\n      width: auto;\n    }\n\n    select[name=\"user-role\"]:disabled {\n      cursor: not-allowed;\n    }\n\n    form > label[for=\"send-email\"] {\n      margin-left: 0.5em;\n    }\n\n    div.error {\n      margin-top: 1rem;\n      padding: 0.5rem 0.75rem;\n      display: none;\n    }\n\n    div.error.show {\n      display: block;\n    }\n  `,\n];\n","import { html } from \"lit\";\nimport { customElement, property, query, state } from \"lit/decorators.js\";\nimport ArchAPI from \"../../lib/ArchAPI\";\nimport {\n  ResponseError,\n  Team,\n  User,\n  UserRoles,\n  UserUpdate,\n} from \"../../lib/types\";\n\nimport \"../../archUserTeamsSelector\";\nimport { ArchUserTeamsSelector } from \"../../archUserTeamsSelector\";\nimport { ArchModal } from \"../../archModal/index\";\n\nimport styles from \"./styles\";\n\n@customElement(\"arch-edit-user-modal\")\nexport class ArchEditUserModal extends ArchModal {\n  @property({ type: Number }) userId!: User[\"id\"];\n  @property({ type: Boolean }) profileMode = false;\n  // eslint-disable-next-line @typescript-eslint/no-unused-vars\n  @property() onUpdate: (user: User) => void = (user) => null;\n\n  @query(\"form\") form!: HTMLFormElement;\n  @query(\"form > input#user-email\") emailInput!: HTMLInputElement;\n  @query(\"div.error\") errorEl!: HTMLElement;\n  @query(\"arch-user-teams-selector\")\n  teamsSelector!: ArchUserTeamsSelector;\n\n  @state() accountTeams: Array<Team> = [];\n\n  constructor() {\n    super();\n    void ArchAPI.teams\n      .list()\n      .then((response) => (this.accountTeams = response.items));\n  }\n\n  private set unhandledError(showError: boolean) {\n    const { errorEl } = this;\n    if (showError) {\n      errorEl.classList.add(\"show\");\n    } else {\n      errorEl.classList.remove(\"show\");\n    }\n  }\n\n  static styles = styles;\n\n  set user(user: undefined | User) {\n    const { accountTeams, profileMode, userId } = this;\n    // Clear the content if user has been set to undefined.\n    if (user === undefined) {\n      this.content = html``;\n      return;\n    }\n    const userIsSelf = user.id === userId;\n    const userIsAdmin = user.role === UserRoles.ADMIN;\n    this.content = html`\n      <form validate>\n        <input type=\"hidden\" name=\"id\" value=${user.id} />\n\n        <label for=\"first-name\">First Name</label>\n        <input\n          id=\"first-name\"\n          name=\"first-name\"\n          type=\"text\"\n          value=${user.first_name}\n        />\n\n        <label for=\"last-name\">Last Name</label>\n        <input\n          id=\"last-name\"\n          name=\"last-name\"\n          type=\"text\"\n          value=${user.last_name}\n        />\n\n        <label for=\"user-email\">Email</label>\n        <input\n          id=\"user-email\"\n          name=\"user-email\"\n          type=\"email\"\n          required\n          value=${user.email}\n        />\n\n        ${profileMode\n          ? html``\n          : html`\n              <label for=\"user-role\">Role</label>\n              <select\n                id=\"user-role\"\n                name=\"user-role\"\n                required\n                ?disabled=${userIsSelf}\n                title=${userIsSelf\n                  ? \"Your role can only be changed by another Admin\"\n                  : \"Select user role\"}\n              >\n                ${Object.entries(UserRoles).map(\n                  ([k, v]) => html`\n                    <option value=\"${v}\" ?selected=${k === user.role}>\n                      ${k}\n                    </option>\n                  `\n                )}\n              </select>\n            `}\n        ${accountTeams.length === 0 && profileMode && !userIsAdmin\n          ? html``\n          : html`\n              <label for=\"user-teams-selector\">Teams</label>\n              <arch-user-teams-selector\n                .accountTeams=${accountTeams}\n                .userTeams=${user.teams}\n                .readOnly=${!profileMode\n                  ? false\n                  : user.role !== UserRoles.ADMIN}\n                id=\"user-teams-selector\"\n              >\n              </arch-user-teams-selector>\n            `}\n      </form>\n      <div class=\"error alert-danger\">\n        Something went wrong. Please try again.\n      </div>\n    `;\n  }\n\n  connectedCallback() {\n    super.connectedCallback();\n    const { profileMode } = this;\n    this.scrollable = true;\n    this.modalSize = \"m\";\n    this.submitButtonText = \"Save\";\n    this.title = profileMode ? \"Edit Profile\" : \"Edit User\";\n    this.addEventListener(\"sp-opened\", this.onOpenHandler.bind(this));\n    this.addEventListener(\"sp-closed\", this.onCloseHandler.bind(this));\n  }\n\n  submit() {\n    const { form, teamsSelector } = this;\n\n    // Validate the form and show any errors.\n    if (!form.checkValidity()) {\n      form.reportValidity();\n      return;\n    }\n\n    const formData = new FormData(this.form);\n    const userId = parseInt(formData.get(\"id\") as string);\n    const data: UserUpdate = {\n      email: formData.get(\"user-email\") as string,\n      first_name: formData.get(\"first-name\") as string,\n      last_name: formData.get(\"last-name\") as string,\n      role: formData.get(\"user-role\") as User[\"role\"],\n      teams: teamsSelector.selectedOptions,\n    };\n    this.updateUser(userId, data);\n  }\n\n  private clearErrors() {\n    this.unhandledError = false;\n    if (this.form) {\n      this.emailInput.setCustomValidity(\"\");\n    }\n  }\n\n  private clearInputValidityOnChange(inputEl: HTMLInputElement) {\n    /* Clear the custom validity error message for the specified input\n     element on the first \"input\" event using a one-shot handler. */\n    const handler = () => {\n      inputEl.setCustomValidity(\"\");\n      inputEl.removeEventListener(\"input\", handler);\n    };\n    inputEl.addEventListener(\"input\", handler);\n  }\n\n  private updateUser(userId: User[\"id\"], data: UserUpdate) {\n    this.clearErrors();\n    ArchAPI.users\n      .update(userId, data)\n      .then((user: User) => {\n        this.open = false;\n        // Invoke any registered onUpdate handler and catch/log any error\n        // to prevent triggering display of the modal error element.\n        try {\n          this.onUpdate(user);\n        } catch (e) {\n          console.error(e);\n        }\n      })\n      .catch((error: ResponseError) => {\n        if (error.response?.status !== 400) {\n          this.unhandledError = true;\n        } else {\n          error.response\n            .json()\n            .then((data: { details: string }) => {\n              const { details } = data;\n              // Maybe handle a duplicate email error.\n              if (details.endsWith(\"already exists for field (email)\")) {\n                this.emailInput.setCustomValidity(\n                  \"A user with this Email already exists.\"\n                );\n                this.emailInput.reportValidity();\n                this.clearInputValidityOnChange(this.emailInput);\n              } else {\n                this.unhandledError = true;\n              }\n            })\n            .catch(() => (this.unhandledError = true));\n        }\n      });\n  }\n\n  onOpenHandler(): void {\n    /* In profile mode, load the user data on each open. */\n    const { profileMode, userId } = this;\n    if (profileMode) {\n      void ArchAPI.users.get(userId).then((user) => (this.user = user));\n    }\n  }\n\n  onCloseHandler(): void {\n    /* Clear error on close, and in profile mode, set user=undefined to prevent\n       a flash of potentially-stale user data prior to fetch completion.\n     */\n    const { profileMode } = this;\n    this.form?.reset();\n    this.teamsSelector.reset();\n    this.clearErrors();\n    if (profileMode) {\n      this.user = undefined;\n    }\n  }\n}\n"],"names":["styles$1","global","css","ArchUserTeamsSelector","ArchSelectAdder","connectedCallback","readOnly","this","reset","deselectButtonText","emptyOptionsPlaceholder","html","Paths","teams","headingLevel","readOnlyMessage","undefined","selectCtaText","valueGetter","x","String","id","labelGetter","name","super","willUpdate","changedProperties","has","accountTeams","userTeams","options","slice","selectedOptions","styles","__decorate","property","type","Array","prototype","Boolean","customElement","ArchModal","Bootstrap4Alerts","ArchEditUserModal","constructor","profileMode","onUpdate","user","ArchAPI","list","then","response","items","unhandledError","showError","errorEl","classList","add","remove","userId","content","userIsSelf","userIsAdmin","role","UserRoles","ADMIN","first_name","last_name","email","Object","entries","map","k","v","length","scrollable","modalSize","submitButtonText","title","addEventListener","onOpenHandler","bind","onCloseHandler","submit","form","teamsSelector","checkValidity","reportValidity","formData","FormData","parseInt","get","data","updateUser","clearErrors","emailInput","setCustomValidity","clearInputValidityOnChange","inputEl","handler","removeEventListener","users","update","open","e","console","error","catch","_a","status","json","details","endsWith","Number","query","state"],"mappings":"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"}