
{%
  set dataset_displayname = (
    dataset.job_start.collection.name
    + ": "
    + dataset.job_start.job_type.name
    + (" (Sample)" if dataset.job_start.sample else "")
  )
%}
{% set wasapi_result_abs_url = abs_url('wasapi:file_listing', args=[dataset.id]) %}


{% set breadcrumbs = (("Datasets", "datasets-explore"), (dataset_displayname, ("dataset-detail", dataset.id))) %}
{% extends 'keystone/base.html' %}

{% block header_title %}
  {{ dataset_displayname }}
{% endblock %}

{% block head_extra %}
<script src="{{ static('/js/ext/jquery.min.js') }}"></script>
{% if dataset.job_start.job_type.can_publish %}
<script src="{{ static('/js/arch-dataset-publishing-card.js') }}" type="module"></script>
<script src="{{ static('/js/arch-hover-tooltip.js') }}" type="module"></script>
{% endif %}

<script>
  function init() {
    // For the time being, just port existing rerun button click handler.
    document.getElementById("job-rerunbutton").addEventListener("click", async (e) => {
      const ok = confirm(
        "You are about to regenerate this dataset which will permanently overwrite the existing version."
      )
      if (!ok) {
        return;
      }
      const { target } = e;
      target.disabled = true;
      const res = await fetch(
        "/api/datasets/generate", {
          method: "POST",
          credentials: "same-origin",
          headers: { "X-CSRFToken": "{{ csrf_token }}" },
          mode: "cors",
          body: JSON.stringify({
            collection_id: {{ dataset.job_start.collection.id }},
            job_type_id: "{{ dataset.job_start.job_type.id }}",
            is_sample: {{ dataset.job_start.sample | tojson }},
            rerun: true
          }),
        });
      if (res.ok) {
        window.location = "/datasets";
      } else {
        target.disabled = false;
      }
    });
  }

  document.addEventListener("DOMContentLoaded", () => init());
</script>
{% endblock %}

{% block content %}
<br>
<br>
<div class="row">
  <div class="large-12 columns">

    <h2 id="dataset">Dataset</h2>
    <p>
      {{ dataset.job_start.job_type.description }}
    </p>
    <div class="card">
      <div class="card-body">
        <p class="card-text">
          <strong>Number of files</strong>: {{ dataset.job_start.jobcomplete.jobfile_set.count() }}
        </p>
      </div>
    </div>
    <div class="card">
      <div class="card-body">
        <h2 id="download" class="card-title">Download</h2>
        <p>To download the files of this dataset, please use the <a href="https://github.com/WASAPI-Community/data-transfer-apis" target="_blank">WASAPI Data Transfer APIs</a> and follow the instructions <a href="https://support.archive-it.org/hc/en-us/articles/360015225051-Find-and-download-your-WARC-files-with-WASAPI" target="_blank">here.</a>
        </p>
        <p>The <a href="https://support.archive-it.org/hc/en-us/articles/360028548952" target="_blank">WASAPI result endpoint URL</a> of this dataset is:
          <br />
          <i><a href="{{ wasapi_result_abs_url }}" target="_blank">{{ wasapi_result_abs_url }}</a></i>
        </p>
        <h3>Command line example</h3>
        <hr />
        <h4>Download files</h4>
        <p class="card-text" style="font-weight: bold;">
          $ <code style="font-weight: normal;">
          <!-- <% if (wasapiPages > 1) { %>
               for i in {1..<%=unescape(wasapiPages)%>}; do curl -u &lt;user&gt;:&lt;password&gt; "<%=unescape(wasapiUrl)%>&amp;page=$i" | jq -r '.files[].locations[0]'; done &gt; url.list
               <% } else { %> -->
             curl -u &lt;user&gt;:&lt;password&gt; {{ wasapi_result_abs_url }} | jq -r '.files[].locations[0]' &gt; url.list
          </code>
          <br />
          $ <code style="font-weight: normal;">
             wget -i url.list
          </code>
        </p>
        <hr />
        <h4>Validate files</h4>
        <p class="card-text" style="font-weight: bold;">
          $ <code style="font-weight: normal;">
          <!-- <% if (wasapiPages > 1) { %>
               for i in {1..<%=unescape(wasapiPages)%>}; do curl -u &lt;user&gt;:&lt;password&gt; "<%=unescape(wasapiUrl)%>&amp;page=$i" | jq -r '.files[] | .filename + "  " + .checksums[]' &gt; manifest
               <% } else { %> -->
             curl -u &lt;user&gt;:&lt;password&gt; {{ wasapi_result_abs_url }} | jq -r '.files[] | .checksums[] + "  " + .filename' &gt; manifest
          </code>
          <br />
          $ <code style="font-weight: normal;">
             md5sum -c manifest
          </code>
        </p>
      </div>
    </div>

    {% if dataset.job_start.job_type.can_publish %}
    <h2 id="publishing">Publishing</h2>
    <p>Publish this dataset to <a href="https://archive.org">archive.org</a> for public access.</p>
    <div class="card">
      <div class="card-body">
        <arch-dataset-publishing-card
          datasetId="{{ dataset.id }}"
          csrfToken="{{ csrf_token }}"
        >
        </arch-dataset-publishing-card>
      </div>
    </div>
    {% endif %}

    <h2 id="regenerate">Regenerate</h2>
    <div class="card" id="card-re-run-job">
      <div class="card-body">
        <p>
          The new dataset will include any content added to the collection since this was last generated.
          <br />
          <strong>Regenerating this dataset will permanently overwrite the current version.</strong>
        </p>
        <button id="job-rerunbutton">Regenerate Dataset</button>
      </div>
    </div>

  </div>
</div>
{% endblock %}
